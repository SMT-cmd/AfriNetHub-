<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AFRINETHUB â€” Premium Deals</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ›’</text></svg>">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            darkbg: '#0f1724', // Slate-900 like (from reference)
            darkcard: '#1e293b', // Slate-800 like
            lightbg: '#f1f5f9', // Slate-100 (Dim Light)
            lightcard: '#ffffff',
            primary: '#fbbf24', // Amber-400
          }
        }
      }
    }
  </script>

  <style>
    html,body,#root { height: 100%; }
    /* Transitions for theme switch */
    body { transition: background-color 0.3s, color 0.3s; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .animate-in { animation: fadeIn .18s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px) } to { opacity: 1; transform: translateY(0) } }
    .btn-disabled { opacity: 0.6; pointer-events: none; cursor: not-allowed; }
    .img-control { background: rgba(15,23,36,0.6); width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; border-radius:9999px; color:#fff; transition:background .15s; border: 1px solid rgba(255,255,255,0.1); }
    .img-control:hover { background: rgba(255,255,255,0.2); }
    .img-indicators { gap:6px; display:inline-flex; align-items:center; }
    .img-indicators button { width:8px; height:8px; border-radius:9999px; background: rgba(148,163,184,0.3); border: none; padding:0; }
    .img-indicators button.active { background:#fbbf24; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <!-- React & ReactDOM + Babel for in-browser JSX -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    // ---------- STORAGE CONFIG ----------
    // 1. Firebase (Existing)
    const firebaseConfig = {
      apiKey: "AIzaSyDmzzR9iOp19RbM0uY19aKzJ9T3Nm5_6-k",
      authDomain: "afrinethub.firebaseapp.com",
      projectId: "afrinethub",
      storageBucket: "afrinethub.appspot.com",
      messagingSenderId: "313556528568",
      appId: "1:313556528568:web:f8b1cda91950bbe953734d",
      measurementId: "G-KCZD4HLCQ1"
    };

    // 2. Cloudinary (Recommended Alternative for Images)
    // To use Cloudinary: 
    // - Sign up at Cloudinary.com
    // - Get your 'cloudName' from the dashboard
    // - Create an 'Unsigned Upload Preset' in Settings > Upload
    const cloudinaryConfig = {
      cloudName: "dw8q1kfgn", 
      uploadPreset: "afrinet_preset" // IMPORTANT: You must create this 'Unsigned' preset in Cloudinary Settings > Upload
    };

    let db = null;
    let storage = null;

    try {
      if (firebaseConfig && firebaseConfig.apiKey) {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        storage = firebase.storage();
        console.log('Firebase initialized');
      }
    } catch (e) {
      console.warn('Firebase init failed', e);
    }

    // ---------- ICONS ----------
    const Icon = ({ children, className = "w-5 h-5", ...props }) => (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className={className} {...props}>
        {children}
      </svg>
    );
    const ShoppingCart = (p) => (<Icon {...p}><path d="M3 3h2l.4 2M7 13h10l3-8H6.4" strokeLinecap="round" strokeLinejoin="round"/><circle cx="10" cy="20" r="1" /><circle cx="18" cy="20" r="1" /></Icon>);
    const MessageCircle = (p) => (<Icon {...p}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8A8.5 8.5 0 1 1 11.5 3" strokeLinecap="round" strokeLinejoin="round" /><path d="M21 21l-5.2-3" strokeLinecap="round" strokeLinejoin="round" /></Icon>);
    const Menu = (p) => (<Icon {...p}><path d="M4 6h16M4 12h16M4 18h16" strokeLinecap="round" strokeLinejoin="round" /></Icon>);
    const X = (p) => (<Icon {...p}><path d="M18 6L6 18M6 6l12 12" strokeLinecap="round" strokeLinejoin="round" /></Icon>);
    const Search = (p) => (<Icon {...p}><path d="M21 21l-4.35-4.35" strokeLinecap="round" strokeLinejoin="round" /><circle cx="11" cy="11" r="6" /></Icon>);
    const Plus = (p) => (<Icon {...p}><path d="M12 5v14M5 12h14" strokeLinecap="round" strokeLinejoin="round" /></Icon>);
    const Trash = (p) => (<Icon {...p}><path d="M3 6h18M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" strokeLinecap="round" strokeLinejoin="round"/><path d="M10 10v6M14 10v6" strokeLinecap="round" strokeLinejoin="round" /></Icon>);
    const Edit = (p) => (<Icon {...p}><path d="M3 21v-3l11-11 3 3L6 21H3z" strokeLinecap="round" strokeLinejoin="round"/><path d="M14 7l3 3" strokeLinecap="round" strokeLinejoin="round"/></Icon>);
    const Lock = (p) => (<Icon {...p}><rect x="3" y="11" width="18" height="10" rx="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" strokeLinecap="round" strokeLinejoin="round"/></Icon>);
    const Upload = (p) => (<Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" strokeLinecap="round" strokeLinejoin="round"/><path d="M17 8l-5-5-5 5M12 3v12" strokeLinecap="round" strokeLinejoin="round"/></Icon>);
    const Prev = (p) => (<Icon {...p}><path d="M15 6l-6 6 6 6" strokeLinecap="round" strokeLinejoin="round" /></Icon>);
    const Next = (p) => (<Icon {...p}><path d="M9 6l6 6-6 6" strokeLinecap="round" strokeLinejoin="round" /></Icon>);
    const Sun = (p) => (<Icon {...p}><circle cx="12" cy="12" r="5" /><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" strokeLinecap="round" strokeLinejoin="round" /></Icon>);
    const Moon = (p) => (<Icon {...p}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" strokeLinecap="round" strokeLinejoin="round" /></Icon>);

    // ---------- constants & helpers ----------
    const LOCAL_STORAGE_CART_KEY = 'afri_cart_v1';
    const OFFICIAL_WHATSAPP = '2348140813999';
    const NAIRA = 'â‚¦';
    const ADMIN_PLAIN_PASSCODE = '#112AfriNethubnodeyplay112#'; // plain passcode per request

    const formatMoney = (amount) => NAIRA + Number(amount || 0).toLocaleString(undefined, { maximumFractionDigits: 0 });

    const withTimeout = (promise, ms = 8000) => {
      return Promise.race([
        promise,
        new Promise((_, reject) => setTimeout(() => reject(new Error('Operation timed out. Please check your internet or Firebase configuration.')), ms))
      ]);
    };

    const useLocalStorageState = (key, initial) => {
      const [state, setState] = useState(() => {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : initial;
        } catch {
          return initial;
        }
      });
      useEffect(() => {
        try { localStorage.setItem(key, JSON.stringify(state)); } catch {}
      }, [key, state]);
      return [state, setState];
    };

    // ---------- ProductCard ----------
    function ProductCard({ product, isAdmin, onAddToCart, onEdit, onDelete }) {
      const [idx, setIdx] = useState(0);
      const images = product.images || [];
      const urls = images.map(i => (typeof i === 'string' ? i : (i.url || '')));
      useEffect(() => { if (idx >= urls.length) setIdx(0); }, [urls.length]);

      return (
        <article className="group bg-white dark:bg-slate-900 rounded-2xl overflow-hidden border border-slate-200 dark:border-slate-800 relative flex flex-col shadow-sm dark:shadow-none transition-colors duration-300">
          <div className="h-64 bg-slate-100 dark:bg-slate-800 relative overflow-hidden">
            <img src={urls[idx]} alt={`${product.name} â€¢ ${product.brand}`} loading="lazy" className="w-full h-full object-cover transition-transform group-hover:scale-105" />
            <div className="absolute top-4 left-4">
              <span className="bg-slate-900/90 dark:bg-slate-950/80 text-white px-3 py-1 rounded-full text-xs font-bold uppercase backdrop-blur-sm">{product.category}</span>
            </div>

            {urls.length > 1 && (
              <>
                <div className="absolute inset-y-0 left-3 flex items-center">
                  <button onClick={(e)=>{ e.stopPropagation(); setIdx(i => (i - 1 + urls.length) % urls.length); }} aria-label="Previous" className="img-control"><Prev className="w-4 h-4" /></button>
                </div>
                <div className="absolute inset-y-0 right-3 flex items-center">
                  <button onClick={(e)=>{ e.stopPropagation(); setIdx(i => (i + 1) % urls.length); }} aria-label="Next" className="img-control"><Next className="w-4 h-4" /></button>
                </div>
              </>
            )}
          </div>

          <div className="p-6 flex flex-col flex-1">
            <h3 className="text-xl font-bold mb-1 text-slate-900 dark:text-slate-50">{product.name}</h3>
            <p className="text-slate-500 dark:text-slate-500 text-xs font-bold uppercase tracking-widest mb-2">{product.brand}</p>
            <p className="text-slate-600 dark:text-slate-400 text-sm mb-4 italic line-clamp-1">"{product.description}"</p>

            <div className="flex items-center justify-between mt-auto">
              <div>
                {product.oldPrice > product.price && <div className="text-xs text-slate-400 dark:text-slate-500 line-through">{formatMoney(product.oldPrice)}</div>}
                <div className="text-2xl font-black text-amber-500 dark:text-amber-400">{formatMoney(product.price)}</div>
              </div>

              {isAdmin ? (
                <div className="flex gap-2">
                  <button onClick={() => onEdit(product)} className="p-2 bg-slate-100 dark:bg-slate-800 rounded text-blue-600 dark:text-blue-400 border border-slate-200 dark:border-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700"><Edit /></button>
                  <button onClick={() => onDelete(product.id)} className="p-2 bg-slate-100 dark:bg-slate-800 rounded text-red-500 dark:text-red-400 border border-slate-200 dark:border-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700"><Trash /></button>
                </div>
              ) : (
                <button onClick={() => onAddToCart(product)} className="flex items-center gap-2 bg-amber-400 text-slate-900 px-4 py-2 rounded font-bold hover:bg-amber-500 transition-colors shadow-lg shadow-amber-400/20">
                  <ShoppingCart /> Add to Cart
                </button>
              )}
            </div>
          </div>
        </article>
      );
    }

    // ---------- App (with isAdminAllowed & isAdminActive) ----------
    function App() {
      // Persisted "allowed" flag (device remembered) and session "active" flag (controls UI)
      const [isAdminAllowed, setIsAdminAllowed] = useState(() => {
        try { return localStorage.getItem('afri_is_admin') === '1'; } catch { return false; }
      });
      const [isAdminActive, setIsAdminActive] = useState(false); // session-level activation
      const [showLogin, setShowLogin] = useState(false);
      const [loginCode, setLoginCode] = useState('');
      const [activeCategory, setActiveCategory] = useState('All');
      const [isMenuOpen, setIsMenuOpen] = useState(false);
      const [searchTerm, setSearchTerm] = useState('');
      const [showUploadModal, setShowUploadModal] = useState(false);
      const [editingProduct, setEditingProduct] = useState(null);
      const fileInputRef = useRef(null);

      // products & cart
      const [products, setProducts] = useState([]);
      const [cart, setCart] = useLocalStorageState(LOCAL_STORAGE_CART_KEY, []);
      const [showCart, setShowCart] = useState(false);

      // form
      const [formData, setFormData] = useState({ name:'', category:'Phones', brand:'', price:'', oldPrice:'', images:[], newFiles:[], description:'' });
      const [isSaving, setIsSaving] = useState(false);
      const [imageUrlInput, setImageUrlInput] = useState('');
      const [theme, setTheme] = useLocalStorageState('afri_theme', 'dark');

      // Theme Effect - Body classes
      useEffect(() => {
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
          document.body.style.backgroundColor = '#0f1724'; // darkbg
          document.body.style.color = '#e6eef8';
        } else {
          document.documentElement.classList.remove('dark');
          document.body.style.backgroundColor = '#f1f5f9'; // lightbg (dim)
          document.body.style.color = '#0f1724';
        }
      }, [theme]);



      // local defaults (used if Firestore not available)
      const localDefaults = [
        { id: 1, name: 'Toyota Camry 2022 XLE', category: 'Cars', brand: 'Toyota', price: 28500000, oldPrice: 30000000, images: ['https://images.unsplash.com/photo-1621007947382-bb3c3994e3fb?w=1200&q=60'], description: 'Foreign Used, Full Option' },
        { id: 2, name: 'iPhone 16 Pro Max', category: 'Phones', brand: 'Apple', price: 2150000, oldPrice: 2300000, images: ['https://images.unsplash.com/photo-1727116195101-72f85bc67858?w=1200&q=60'], description: '256GB, Desert Titanium' }
      ];

      // Load products: prefer Firestore realtime, fallback to local
      useEffect(() => {
        if (db) {
          const unsub = db.collection('products').orderBy('createdAt','desc').onSnapshot(snap => {
            const arr = [];
            snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
            setProducts(arr);
          }, err => {
            console.error('Firestore listen error', err);
            setProducts(localDefaults);
          });
          return () => unsub();
        } else {
          const persisted = localStorage.getItem('afri_products_v3');
          if (persisted) {
            try { setProducts(JSON.parse(persisted)); } catch { setProducts(localDefaults); }
          } else setProducts(localDefaults);
        }
      }, []);

      // persist local products when Firestore not used
      useEffect(() => {
        if (!db) {
          try { 
            localStorage.setItem('afri_products_v3', JSON.stringify(products)); 
          } catch (e) {
            console.error('Storage quota exceeded', e);
          }
        }
      }, [products]);

      // editing -> populate form
      useEffect(() => {
        if (editingProduct) {
          setFormData({
            name: editingProduct.name || '',
            category: editingProduct.category || 'Phones',
            brand: editingProduct.brand || '',
            price: editingProduct.price || '',
            oldPrice: editingProduct.oldPrice || '',
            images: editingProduct.images || [],
            newFiles: [],
            description: editingProduct.description || ''
          });
        }
      }, [editingProduct]);



      // CART helpers
      const calculateTotal = () => cart.reduce((sum, item) => sum + (Number(item.price) || 0) * (item.qty || 1), 0);

      const addToCart = (product) => {
        setCart(prev => {
          const idx = prev.findIndex(p => p.id === product.id);
          if (idx >= 0) {
            const next = [...prev]; next[idx] = { ...next[idx], qty: next[idx].qty + 1 }; return next;
          }
          return [{ ...product, qty: 1 }, ...prev];
        });
        setShowCart(true);
      };

      const changeQty = (id, newQty) => setCart(prev => {
        if (newQty <= 0) return prev.filter(p => p.id !== id);
        return prev.map(p => p.id === id ? { ...p, qty: newQty } : p);
      });

      const removeFromCart = (id) => setCart(prev => prev.filter(p => p.id !== id));

      const handleCheckout = () => {
        const total = formatMoney(calculateTotal());
        let message = `ðŸ’¸ *NEW ORDER FROM AFRINETHUB*\n\n`;
        cart.forEach((item, index) => {
          message += `${index + 1}. *${item.name}* (${item.brand})\n   Qty: ${item.qty} â€¢ Price: ${formatMoney(item.price)}\n\n`;
        });
        message += `ðŸ’ *TOTAL AMOUNT: ${total}*\n\nPlease confirm availability for these items.`;
        window.open(`https://wa.me/${OFFICIAL_WHATSAPP}?text=${encodeURIComponent(message)}`, '_blank');
      };



      // ---------- URL Admin Trigger ----------
      useEffect(() => {
        const checkAdminUrl = () => {
          const href = window.location.href;
          if (href.includes('admin') || href.includes('#admin') || href.includes('?admin')) {
            if (!isAdminActive) setShowLogin(true);
          }
        };
        checkAdminUrl();
        window.addEventListener('hashchange', checkAdminUrl);
        return () => window.removeEventListener('hashchange', checkAdminUrl);
      }, [isAdminActive]);

      // ---------- Access code login ----------
      const handleAccessCodeLogin = () => {
        if (!loginCode || loginCode.trim() === '') { alert('Enter access code'); return; }
        if (loginCode.trim() === ADMIN_PLAIN_PASSCODE) {
          try { localStorage.setItem('afri_is_admin','1'); } catch {}
          setIsAdminAllowed(true);   // remember device is allowed
          setIsAdminActive(true);    // activate this session so UI appears
          setShowLogin(false);
          setLoginCode('');
          // optionally open upload immediately:
          setShowUploadModal(true);
        } else {
          alert('Wrong access code.');
        }
      };

      // Sign out should deactivate session only (keeps allowed flag so device remains recognized).
      const handleSignOut = () => {
        setIsAdminActive(false);
        // optionally: to remove remembered device uncomment the two lines below:
        // try { localStorage.removeItem('afri_is_admin'); } catch {}
        // setIsAdminAllowed(false);
      };

      // ---------- Image upload ----------
      const handleAddImageUrl = () => {
        if (!imageUrlInput) return;
        if (formData.images.length >= 8) { alert('Maximum 8 images allowed'); return; }
        setFormData(prev => ({ ...prev, images: [...prev.images, imageUrlInput] }));
        setImageUrlInput('');
      };

      const handleImageUpload = (e) => {
        const files = Array.from(e.target.files || []);
        if (files.length === 0) return;
        if (files.length + formData.images.length > 8) { alert('Maximum 8 images allowed'); return; }

        files.forEach(file => {
          const reader = new FileReader();
          reader.onloadend = () => {
            if (reader.result) {
              setFormData(prev => ({ ...prev, images: [...prev.images, reader.result], newFiles: [...prev.newFiles, file] }));
            }
          };
          reader.onerror = () => {
            alert('Failed to read file: ' + file.name);
          };
          reader.readAsDataURL(file);
        });
        e.target.value = '';
      };

      const removeImage = (index) => {
        setFormData(prev => {
          const images = prev.images.filter((_, i) => i !== index);
          const newFiles = prev.newFiles.slice(0, Math.max(0, prev.newFiles.length - (prev.images.length - index)));
          return { ...prev, images, newFiles };
        });
      };

      // ---------- Save product (requires isAdminActive) ----------
      const handleSaveProduct = async (e) => {
        if (e && e.preventDefault) e.preventDefault();
        if (!isAdminActive) { alert('Only active admin sessions can save products.'); return; }

        setIsSaving(true);
        let currentStep = 'Preparing';

        try {
          const uploaded = [];
          
          // --- STEP 1: UPLOAD IMAGES TO CLOUDINARY ---
          if (formData.newFiles.length > 0) {
            currentStep = 'Uploading images to Cloudinary';
            if (cloudinaryConfig.cloudName && cloudinaryConfig.uploadPreset) {
              for (const file of formData.newFiles) {
                const url = `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`;
                const fd = new FormData();
                fd.append('upload_preset', cloudinaryConfig.uploadPreset);
                fd.append('file', file);

                const resp = await fetch(url, { method: 'POST', body: fd });
                const data = await resp.json();
                if (data.secure_url) {
                  uploaded.push({ path: data.public_id, url: data.secure_url });
                } else {
                  throw new Error(data.error?.message || 'Cloudinary rejected the upload.');
                }
              }
            } else {
              throw new Error('Cloudinary is not configured. Please provide Cloud Name and Upload Preset.');
            }
          }

          // --- STEP 2: SAVE DATA TO LOCAL STORAGE ---
          currentStep = 'Saving to local memory';
          
          const existingRemote = (formData.images || []).filter(i => {
            if (typeof i === 'string') return i.startsWith('http');
            return i && i.url;
          }).map(i => (typeof i === 'string' ? { path: null, url: i } : { path: i.path || null, url: i.url }));

          const finalImages = [...existingRemote, ...uploaded];

          const newProd = {
            name: formData.name,
            category: formData.category,
            brand: formData.brand,
            price: Number(formData.price),
            oldPrice: Number(formData.oldPrice),
            description: formData.description,
            images: finalImages,
            updatedAt: new Date().toISOString()
          };

          // --- STEP 2: SAVE DATA TO CLOUD (FIRESTORE) ---
          currentStep = 'Saving to global database';
          
          if (db) {
            const docId = editingProduct ? String(editingProduct.id) : String(Date.now());
            await db.collection('products').doc(docId).set({
              ...newProd,
              id: docId,
              createdAt: editingProduct ? (editingProduct.createdAt || new Date().toISOString()) : new Date().toISOString()
            });
            console.log('Saved to Firestore successfully');
          } else {
            // Fallback to local if Firebase fails to init
            setProducts(prev => {
              const updatedProd = { ...newProd, id: editingProduct ? editingProduct.id : Date.now() };
              const updated = editingProduct 
                ? prev.map(p => p.id === updatedProd.id ? updatedProd : p)
                : [updatedProd, ...prev];
              
              try {
                localStorage.setItem('afri_products_v3', JSON.stringify(updated));
              } catch (e) { console.error('LocalStorage save failed:', e); }
              return updated;
            });
          }

          alert('ðŸš€ Success! Product is now LIVE for all visitors.');
          
          // CRITICAL: Exit admin view or refresh state to show on main site
          setIsAdminActive(false); 
          
          setShowUploadModal(false);
          setEditingProduct(null);
          setFormData({ name:'', category:'Phones', brand:'', price:'', oldPrice:'', images:[], newFiles:[], description:'' });
        } catch (err) {
          console.error(`Error during ${currentStep}:`, err);
          alert(`âŒ Save Failed\n\nStep: ${currentStep}\nReason: ${err.message}`);
        } finally {
          setIsSaving(false);
        }
      };

      // ---------- Delete product (requires isAdminActive) ----------
      const handleDeleteProduct = async (id) => {
        if (!isAdminActive) { alert('Only active admin sessions can delete products. Use the admin URL to log in.'); return; }
        if (!confirm('Delete this item?')) return;

        try {
          if (db && storage) {
            const docRef = db.collection('products').doc(String(id));
            const snap = await docRef.get();
            if (snap.exists) {
              const data = snap.data();
              if (Array.isArray(data.images)) {
                for (const img of data.images) {
                  const path = img && img.path ? img.path : null;
                  if (path) {
                    try { await storage.ref().child(path).delete(); } catch (e) { console.warn('Failed to delete storage path', path, e); }
                  }
                }
              }
            }
            await db.collection('products').doc(String(id)).delete();
          } else {
            setProducts(prev => prev.filter(p => p.id !== id));
          }
          setCart(prev => prev.filter(c => c.id !== id));
        } catch (err) {
          console.error('Delete error', err);
          alert('Failed to delete product');
        }
      };

      const startEdit = (p) => { setEditingProduct(p); setShowUploadModal(true); };

      // filtering
      const filteredProducts = useMemo(() => {
        const term = searchTerm.trim().toLowerCase();
        return products.filter(p => {
          const matchesCategory = activeCategory === 'All' || p.category === activeCategory;
          if (!term) return matchesCategory;
          const hay = `${p.name} ${p.brand} ${p.description}`.toLowerCase();
          return matchesCategory && hay.includes(term);
        });
      }, [products, searchTerm, activeCategory]);

      // Render
      return (
        <div className="min-h-screen">
          {/* ADMIN BAR */}
          {isAdminActive && (
            <div className="bg-red-600 text-white text-center py-1 text-xs font-bold uppercase tracking-widest fixed top-0 w-full z-[60]">
              Admin Mode Active â€¢ Editing Enabled
            </div>
          )}

          {/* NAV */}
          <nav className={`fixed w-full z-50 bg-white/80 dark:bg-slate-900/90 backdrop-blur border-b border-slate-200 dark:border-slate-800 transition-colors duration-300 ${isAdminActive ? 'top-6' : 'top-0'}`}>
            <div className="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className={`p-2 rounded-lg shadow-lg ${isAdminActive ? 'bg-red-600 text-white' : 'bg-amber-400 text-slate-900'}`}>
                  {isAdminActive ? <Lock className="w-5 h-5" /> : <ShoppingCart className="w-5 h-5" />}
                </div>

                <div>
                  <div className="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-amber-600 to-amber-400 dark:from-amber-300 dark:to-amber-100 tracking-tight">AFRINETHUB</div>
                  <div className="flex items-center gap-2">
                    {isAdminActive && (
                      <div className="flex items-center gap-2">
                        <div className="text-[10px] font-bold border border-red-500 text-red-500 px-1">ADMIN ACTIVE</div>
                        <div className="flex items-center gap-1.5 px-2 py-0.5 bg-slate-100 dark:bg-slate-800 rounded-full border border-slate-200 dark:border-slate-700">
                          <div className={`w-1.5 h-1.5 rounded-full ${db ? 'bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.5)]' : 'bg-red-500 shadow-[0_0_5px_rgba(239,68,68,0.5)]'}`} title={db ? 'Database Live' : 'Database Offline'}></div>
                          <div className={`w-1.5 h-1.5 rounded-full ${cloudinaryConfig.cloudName ? 'bg-blue-500 shadow-[0_0_5px_rgba(59,130,246,0.5)]' : 'bg-amber-500 shadow-[0_0_5px_rgba(245,158,11,0.5)]'}`} title={cloudinaryConfig.cloudName ? 'Cloudinary Ready' : 'Cloudinary Missing'}></div>
                          <span className="text-[9px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-tighter">Sync Active</span>
                        </div>
                      </div>
                    )}
                    {isAdminActive && (
                      <button onClick={handleSignOut} className="text-xs text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white underline">Sign out</button>
                    )}
                  </div>
                </div>
              </div>

              <div className="flex items-center gap-4">
                 <button onClick={()=>setTheme(theme==='dark'?'light':'dark')} className="p-3 rounded-full bg-slate-200 dark:bg-slate-800 hover:bg-slate-300 dark:hover:bg-slate-700 transition-all shadow-lg border-2 border-slate-300 dark:border-slate-600 ring-2 ring-transparent hover:ring-amber-400 active:scale-95 group" aria-label="Toggle Theme" title="Switch Theme">
                  {theme==='dark' ? <Sun className="text-amber-500 w-6 h-6 fill-current" /> : <Moon className="text-slate-700 dark:text-slate-200 w-6 h-6 fill-current" />}
                </button>
                {!isAdminActive && (
                   <button onClick={()=>setShowCart(true)} className="relative p-2 bg-slate-100 dark:bg-slate-800 rounded text-slate-900 dark:text-amber-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                     <ShoppingCart />
                     {cart.length > 0 && (<span className="absolute -top-2 -right-2 bg-red-500 text-white w-5 h-5 rounded-full text-[10px] font-bold flex items-center justify-center border-2 border-white dark:border-slate-900">{cart.reduce((s,i)=>s+(i.qty||1),0)}</span>)}
                   </button>
                )}
              </div>
            </div>
          </nav>

          {/* MAIN CONTENT SWITCHER */}
          {isAdminActive ? (
             <main className="pt-32 pb-12 px-4 max-w-7xl mx-auto">
                <div className="grid lg:grid-cols-12 gap-8">
                   {/* LEFT COLUMN: EDITOR */}
                   <div className="lg:col-span-5 xl:col-span-4">
                      <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-6 sticky top-28 shadow-xl">
                         <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-black text-slate-900 dark:text-slate-100 flex items-center gap-2">
                              {editingProduct ? <><Edit className="text-blue-500"/> Edit Item</> : <><Plus className="text-green-500"/> Add Item</>}
                            </h2>
                            {editingProduct && (
                              <button onClick={()=>{setEditingProduct(null); setFormData({ name:'', category:'Phones', brand:'', price:'', oldPrice:'', images:[], newFiles:[], description:'' });}} className="text-xs font-bold text-red-500 hover:underline">CANCEL</button>
                            )}
                         </div>

                         <form onSubmit={handleSaveProduct} className="flex flex-col gap-4">
                             <div>
                               <label className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 block">Photos (Max 8)</label>
                               <div className="grid grid-cols-4 gap-2 mb-2">
                                 {formData.images.map((img, idx) => (
                                   <div key={idx} className="aspect-square relative rounded overflow-hidden border border-slate-200 dark:border-slate-700 group">
                                     <img src={typeof img === 'string' ? img : (img.url || '')} className="w-full h-full object-cover" />
                                     <button type="button" onClick={()=>removeImage(idx)} className="absolute inset-0 bg-black/50 text-white opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity"><X className="w-4 h-4" /></button>
                                   </div>
                                 ))}
                                 {formData.images.length < 8 && (
                                   <button type="button" onClick={()=>fileInputRef.current.click()} className="aspect-square flex flex-col items-center justify-center border-2 border-dashed border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900/50 rounded text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                                     <Plus className="w-5 h-5" />
                                   </button>
                                 )}
                               </div>
                               <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" multiple className="hidden" />
                               <div className="flex gap-2">
                                 <input value={imageUrlInput} onChange={e => setImageUrlInput(e.target.value)} placeholder="Or paste image URL" className="flex-1 bg-slate-100 dark:bg-slate-950 border border-slate-300 dark:border-slate-700 p-2 rounded text-xs text-slate-900 dark:text-slate-100" />
                                 <button type="button" onClick={handleAddImageUrl} className="bg-slate-200 dark:bg-slate-700 px-3 rounded text-xs font-bold text-slate-900 dark:text-slate-100">Add</button>
                               </div>
                             </div>

                             <input required value={formData.name} onChange={e=>setFormData({...formData,name:e.target.value})} className="w-full bg-slate-100 dark:bg-slate-950 border border-slate-300 dark:border-slate-700 p-3 rounded text-slate-900 dark:text-slate-100 font-bold placeholder-slate-500" placeholder="Product Name" />
                             
                             <div className="grid grid-cols-2 gap-4">
                               <select value={formData.category} onChange={e=>setFormData({...formData,category:e.target.value})} className="bg-slate-100 dark:bg-slate-950 border border-slate-300 dark:border-slate-700 p-3 rounded text-slate-900 dark:text-slate-100 text-sm">
                                 {['Cars','Phones','Laptops','Tablets','Watches'].map(c=><option key={c} value={c}>{c}</option>)}
                               </select>
                               <input required value={formData.brand} onChange={e=>setFormData({...formData,brand:e.target.value})} className="bg-slate-100 dark:bg-slate-950 border border-slate-300 dark:border-slate-700 p-3 rounded text-slate-900 dark:text-slate-100 text-sm" placeholder="Brand" />
                             </div>

                             <div className="grid grid-cols-2 gap-4">
                               <input required type="number" value={formData.price} onChange={e=>setFormData({...formData,price:e.target.value})} className="bg-slate-100 dark:bg-slate-950 border border-slate-300 dark:border-slate-700 p-3 rounded text-slate-900 dark:text-slate-100 text-sm" placeholder="Price" />
                               <input type="number" value={formData.oldPrice} onChange={e=>setFormData({...formData,oldPrice:e.target.value})} className="bg-slate-100 dark:bg-slate-950 border border-slate-300 dark:border-slate-700 p-3 rounded text-slate-900 dark:text-slate-100 text-sm" placeholder="Old Price" />
                             </div>

                             <textarea value={formData.description} onChange={e=>setFormData({...formData,description:e.target.value})} className="w-full bg-slate-100 dark:bg-slate-950 border border-slate-300 dark:border-slate-700 p-3 rounded h-24 text-slate-900 dark:text-slate-100 text-sm resize-none" placeholder="Description"></textarea>

                             <button type="submit" disabled={isSaving} className="w-full bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 font-bold py-3 rounded-xl hover:bg-slate-800 dark:hover:bg-white transition-colors shadow-lg mt-2">
                               {isSaving ? 'Saving...' : (editingProduct ? 'UPDATE PRODUCT' : 'UPLOAD PRODUCT')}
                             </button>
                         </form>
                      </div>
                   </div>

                   {/* RIGHT COLUMN: LIST */}
                   <div className="lg:col-span-7 xl:col-span-8">
                      <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-6 shadow-sm">
                         <h3 className="text-xl font-bold text-slate-900 dark:text-slate-100 mb-6">Inventory ({products.length})</h3>
                         
                         {/* Search within admin */}
                         <div className="mb-6 relative">
                           <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                           <input value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="Search inventory..." className="w-full pl-10 bg-slate-100 dark:bg-slate-950 border border-slate-200 dark:border-slate-700 rounded-lg py-2 text-slate-900 dark:text-slate-100" />
                         </div>

                         <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            {filteredProducts.map(p => (
                               <ProductCard key={p.id} product={p} isAdmin={true} onEdit={(prod)=>{setEditingProduct(prod); window.scrollTo({top:0, behavior:'smooth'});}} onDelete={handleDeleteProduct} />
                            ))}
                         </div>
                      </div>
                   </div>
                </div>
             </main>
          ) : (
            <>
               {/* STANDARD USER LAYOUT */}
               <header className="pt-28 pb-10 px-4">
                  <div className="max-w-7xl mx-auto">
                    <div className="rounded-2xl p-8 md:p-16 bg-gradient-to-br from-slate-200 to-white dark:from-slate-900 dark:to-slate-800 border border-slate-200 dark:border-slate-700 transition-colors duration-300 shadow-sm">
                      <h1 className="text-3xl md:text-5xl font-bold text-slate-900 dark:text-slate-50" spellCheck={false}>Direct Sales from <span className="text-amber-500 dark:text-amber-400 no-underline decoration-0 inline-block border-none outline-none">AfriNethub</span> Global</h1>
                      <p className="text-slate-600 dark:text-slate-400 mt-4">Premium Autos & latest tech. Quality you can trust.</p>
                    </div>
                  </div>
               </header>

               <section className="sticky top-20 z-30 bg-white/80 dark:bg-slate-900/90 backdrop-blur-md py-4 border-b border-slate-200 dark:border-slate-800 transition-colors duration-300">
                 <div className="max-w-7xl mx-auto px-4 flex flex-col md:flex-row gap-4 items-center">
                   <div className="relative w-full md:w-96">
                     <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500"><Search /></div>
                     <input value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="Search items, brands or description..." className="w-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg py-2 pl-10 pr-4 text-slate-900 dark:text-slate-100 placeholder-slate-500 dark:placeholder-slate-500 transition-colors" />
                   </div>
                   <div className="flex gap-2 overflow-x-auto w-full no-scrollbar">
                     {['All','Cars','Phones','Laptops','Tablets','Watches'].map(cat => (
                       <button key={cat} onClick={()=>setActiveCategory(cat)} className={`px-4 py-1.5 rounded-full text-xs font-bold ${activeCategory===cat?'bg-amber-500 text-slate-900':'bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100'} transition-colors`}>{cat}</button>
                     ))}
                   </div>
                 </div>
               </section>

               <main className="py-12 px-4 max-w-7xl mx-auto">
                 <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                   {filteredProducts.map(product => (
                     <ProductCard key={product.id} product={product} isAdmin={false} onAddToCart={addToCart} />
                   ))}
                 </div>
               </main>
            </>
          )}

          {/* SHARED COMPONENTS (Cart, Login) */}
          {/* CART */}
          {showCart && (
            <div className="fixed inset-0 z-50 flex justify-end" role="dialog" aria-label="Cart">
              <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={()=>setShowCart(false)} aria-hidden="true"></div>
              <aside className="relative w-full max-w-md h-full bg-white dark:bg-slate-900 border-l border-slate-200 dark:border-slate-800 p-6 flex flex-col transition-colors duration-300">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold flex items-center gap-2 text-slate-900 dark:text-slate-100"><ShoppingCart /> YOUR CART</h2>
                  <button onClick={()=>setShowCart(false)} aria-label="Close" className="text-slate-900 dark:text-slate-100"><X /></button>
                </div>
                <div className="flex-1 overflow-y-auto py-2">
                  {cart.length === 0 ? (
                    <div className="text-center text-slate-500 dark:text-slate-500 py-12"><div className="mb-4"><ShoppingCart className="w-10 h-10 mx-auto" /></div>Your cart is empty</div>
                  ) : cart.map(item => (
                    <div key={item.id} className="bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-4 rounded-xl mb-3 flex gap-3 items-center">
                      <img src={(item.images && item.images[0] && (item.images[0].url || item.images[0])) || ''} alt={`${item.name} â€¢ ${item.brand}`} className="w-16 h-16 object-cover rounded" />
                      <div className="flex-1">
                        <div className="font-bold text-sm text-slate-900 dark:text-slate-100">{item.name}</div>
                        <div className="text-slate-900 dark:text-amber-400 font-bold">{formatMoney(item.price)}</div>
                        <div className="mt-2 flex items-center gap-2">
                          <button onClick={()=>changeQty(item.id,(item.qty||1)-1)} className="px-2 py-1 bg-white dark:bg-slate-700 rounded border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-slate-100">-</button>
                          <div className="font-bold text-sm text-slate-900 dark:text-slate-100">{item.qty}</div>
                          <button onClick={()=>changeQty(item.id,(item.qty||1)+1)} className="px-2 py-1 bg-white dark:bg-slate-700 rounded border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-slate-100">+</button>
                          <button onClick={()=>removeFromCart(item.id)} className="ml-3 text-red-500 dark:text-red-400 text-sm flex items-center gap-1 hover:text-red-700 dark:hover:text-red-300"><Trash /> Remove</button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
                {cart.length > 0 && (
                  <div className="mt-4">
                    <div className="flex justify-between items-center mb-4"><div className="text-slate-500 dark:text-slate-400">Total:</div><div className="text-2xl font-black text-slate-900 dark:text-slate-100">{formatMoney(calculateTotal())}</div></div>
                    <button onClick={handleCheckout} className="w-full bg-slate-900 dark:bg-amber-400 text-white dark:text-slate-900 font-bold py-3 rounded flex items-center justify-center gap-3 hover:bg-slate-800 dark:hover:bg-amber-500 transition-colors"><MessageCircle /> CHECKOUT VIA WHATSAPP</button>
                  </div>
                )}
              </aside>
            </div>
          )}

          {/* ADMIN LOGIN modal */}
          {showLogin && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onClick={() => setShowLogin(false)}>
              <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 w-full max-w-md shadow-2xl" onClick={(e)=>e.stopPropagation()}>
                <div className="flex justify-center mb-4"><Lock className="w-8 h-8 text-slate-900 dark:text-slate-100" /></div>
                <h3 className="text-xl font-bold text-center mb-4 text-slate-900 dark:text-slate-100">Admin Access</h3>
                <input type="password" value={loginCode} onChange={e=>setLoginCode(e.target.value)} onKeyDown={e=>e.key==='Enter' && handleAccessCodeLogin()} placeholder="Enter access code" className="w-full bg-slate-100 dark:bg-slate-950 border border-slate-300 dark:border-slate-700 p-3 rounded mb-4 text-slate-900 dark:text-slate-100 placeholder-slate-500" />
                <div className="flex gap-3">
                  <button onClick={()=>setShowLogin(false)} className="flex-1 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100">Cancel</button>
                  <button onClick={handleAccessCodeLogin} className="flex-1 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 font-bold rounded hover:bg-slate-800 dark:hover:bg-white py-2">Unlock</button>
                </div>
                <p className="text-xs text-slate-400 dark:text-slate-500 mt-3 text-center">Use URL trigger to open this dialog.</p>
              </div>
            </div>
          )}
          
          {/* Note: UploadModal is removed as it is now inline in admin view */}
          
          {/* FOOTER */}
          {!isAdminActive && (
            <footer className="bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 py-12 mt-12 transition-colors duration-300">
              <div className="max-w-7xl mx-auto px-4 text-center">
                <div className="text-2xl font-black text-slate-900 dark:text-slate-100">AFRINETHUB GLOBAL</div>
                <div className="text-slate-500 dark:text-slate-400 mt-2">Direct High-End Deals â€¢ Based in Nigeria</div>
              </div>
            </footer>
          )}
        </div>
      );
    }

    // Mount
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
